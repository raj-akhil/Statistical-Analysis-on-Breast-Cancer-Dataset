

library(nclSLR)
library(ggplot2)
library(sqldf)
library(tidyverse)
data(airpollution)
## Check data size:
dim(airpollution)
 ## Print the first few rows:
head(airpollution, 3)


#Numerical Summaries
#the mean value  of each p-variable is :
apply(airpollution, 2, mean) 
'''
SMIN     SMEAN      SMAX      PMIN     PMEAN      PMAX       PM2     PERWH   NONPOOR      GE65      LPOP 
47.10000  99.65000 219.87500  44.50000 116.72500 275.53750  72.85875  87.25750  81.82875  85.87500  56.55078 
'''
vari=apply(airpollution, 2, var)


#SMIN       SMEAN        SMAX        PMIN       PMEAN        PMAX         PM2       PERWH     NONPOOR        GE65        LPOP 
#913.15443  2542.93924 14409.35127   337.84810  1508.35380 25312.50491 23920.23764   107.82096    45.45271   465.45253    14.85679 
sum(vari) # Total variation

#[1] 69577.97
det(cov(airpollution)) # generalised variance
'''
8.72131e+29
'''
cov(airpollution)
'''
SMIN     SMEAN       SMAX      PMIN      PMEAN         PMAX         PM2      PERWH   NONPOOR       GE65       LPOP
SMIN     913.154430  874.7443  1097.0127 100.22785  182.48354    -8.256962  2212.32190  39.985316  39.69835  131.41772  13.543716
SMEAN    874.744304 2542.9392  5036.0570 415.32911 1084.07975  2716.810759  3282.93854 109.052025 112.70766  208.38608  73.237597
SMAX    1097.012658 5036.0570 14409.3513 750.51899 2612.75000  9048.498418  3633.64668 266.818671 202.47959  169.13608 118.272652
PMIN     100.227848  415.3291   750.5190 337.84810  496.20253   466.588608   681.14747  11.500000  19.36899  -20.81013  22.859099
PMEAN    182.483544 1084.0797  2612.7500 496.20253 1508.35380  4056.858544   982.00370  72.165380  53.31307  -95.25000  45.436669
PMAX      -8.256962 2716.8108  9048.4984 466.58861 4056.85854 25312.504905  -246.96616 163.838323 143.41853 -505.02057  72.616843
PM2     2212.321899 3282.9385  3633.6467 681.14747  982.00370  -246.966155 23920.23764  92.016832 230.47854  383.08592 157.772005
PERWH     39.985316  109.0520   266.8187  11.50000   72.16538   163.838323    92.01683 107.820956  44.59833  118.32120   2.544737
NONPOOR   39.698354  112.7077   202.4796  19.36899   53.31307   143.418528   230.47854  44.598326  45.45271   37.18592  10.839829
GE65     131.417722  208.3861   169.1361 -20.81013  -95.25000  -505.020570   383.08592 118.321203  37.18592  465.45253   7.926460
LPOP      13.543716   73.2376   118.2727  22.85910   45.43667    72.616843   157.77200   2.544737  10.83983    7.92646  14.856788
'''
cor(airpollution)
'''
                SMIN     SMEAN      SMAX        PMIN      PMEAN         PMAX         PM2      PERWH   NONPOOR        GE65       LPOP
SMIN     1.000000000 0.5740385 0.3024247  0.18044944  0.1554891 -0.001717436  0.47336207 0.12743151 0.1948590  0.20157846 0.11627953
SMEAN    0.574038494 1.0000000 0.8319561  0.44808834  0.5535306  0.338628755  0.42093207 0.20826398 0.3315168  0.19154155 0.37679370
SMAX     0.302424735 0.8319561 1.0000000  0.34015646  0.5604334  0.473790925  0.19572114 0.21406340 0.2501953  0.06530950 0.25562284
PMIN     0.180449445 0.4480883 0.3401565  1.00000000  0.6950989  0.159553313  0.23960598 0.06025395 0.1563026 -0.05247788 0.32265315
PMEAN    0.155489111 0.5535306 0.5604334  0.69509894  1.0000000  0.656554363  0.16348532 0.17894753 0.2036115 -0.11367780 0.30352357
PMAX    -0.001717436 0.3386288 0.4737909  0.15955331  0.6565544  1.000000000 -0.01003661 0.09917366 0.1337081 -0.14713087 0.11841517
PM2      0.473362073 0.4209321 0.1957211  0.23960598  0.1634853 -0.010036612  1.00000000 0.05729714 0.2210385  0.11480895 0.26465782
PERWH    0.127431511 0.2082640 0.2140634  0.06025395  0.1789475  0.099173660  0.05729714 1.00000000 0.6370699  0.52816946 0.06358122
NONPOOR  0.194859019 0.3315168 0.2501953  0.15630263  0.2036115  0.133708132  0.22103848 0.63706991 1.0000000  0.25565891 0.41713832
GE65     0.201578458 0.1915416 0.0653095 -0.05247788 -0.1136778 -0.147130871  0.11480895 0.52816946 0.2556589  1.00000000 0.09531892
LPOP     0.116279527 0.3767937 0.2556228  0.32265315  0.3035236  0.118415169  0.26465782 0.06358122 0.4171383  0.09531892 1.00000000
'''
round(apply(scale(airpollution),2,mean),0) # Standardise the data matrix and use R to verify that the sample mean vector of the standardised data is composed of zero 
'''
         SMIN         SMEAN          SMAX          PMIN         PMEAN          PMAX           PM2         PERWH       NONPOOR          GE65          LPOP 
          0             0              0              0            0             0               0          0           0               0              0 
'''   
#sample covariance matrix is equal to the sample correlation matrix of the original data.
cov(scale(airpollution)) 

'''
               SMIN     SMEAN      SMAX        PMIN      PMEAN         PMAX         PM2      PERWH   NONPOOR        GE65       LPOP
SMIN     1.000000000 0.5740385 0.3024247  0.18044944  0.1554891 -0.001717436  0.47336207 0.12743151 0.1948590  0.20157846 0.11627953
SMEAN    0.574038494 1.0000000 0.8319561  0.44808834  0.5535306  0.338628755  0.42093207 0.20826398 0.3315168  0.19154155 0.37679370
SMAX     0.302424735 0.8319561 1.0000000  0.34015646  0.5604334  0.473790925  0.19572114 0.21406340 0.2501953  0.06530950 0.25562284
PMIN     0.180449445 0.4480883 0.3401565  1.00000000  0.6950989  0.159553313  0.23960598 0.06025395 0.1563026 -0.05247788 0.32265315
PMEAN    0.155489111 0.5535306 0.5604334  0.69509894  1.0000000  0.656554363  0.16348532 0.17894753 0.2036115 -0.11367780 0.30352357
PMAX    -0.001717436 0.3386288 0.4737909  0.15955331  0.6565544  1.000000000 -0.01003661 0.09917366 0.1337081 -0.14713087 0.11841517
PM2      0.473362073 0.4209321 0.1957211  0.23960598  0.1634853 -0.010036612  1.00000000 0.05729714 0.2210385  0.11480895 0.26465782
PERWH    0.127431511 0.2082640 0.2140634  0.06025395  0.1789475  0.099173660  0.05729714 1.00000000 0.6370699  0.52816946 0.06358122
NONPOOR  0.194859019 0.3315168 0.2501953  0.15630263  0.2036115  0.133708132  0.22103848 0.63706991 1.0000000  0.25565891 0.41713832
GE65     0.201578458 0.1915416 0.0653095 -0.05247788 -0.1136778 -0.147130871  0.11480895 0.52816946 0.2556589  1.00000000 0.09531892
LPOP     0.116279527 0.3767937 0.2556228  0.32265315  0.3035236  0.118415169  0.26465782 0.06358122 0.4171383  0.09531892 1.00000000
'''

cor(scale(airpollution))
'''
                SMIN     SMEAN      SMAX        PMIN      PMEAN         PMAX         PM2      PERWH   NONPOOR        GE65       LPOP
SMIN     1.000000000 0.5740385 0.3024247  0.18044944  0.1554891 -0.001717436  0.47336207 0.12743151 0.1948590  0.20157846 0.11627953
SMEAN    0.574038494 1.0000000 0.8319561  0.44808834  0.5535306  0.338628755  0.42093207 0.20826398 0.3315168  0.19154155 0.37679370
SMAX     0.302424735 0.8319561 1.0000000  0.34015646  0.5604334  0.473790925  0.19572114 0.21406340 0.2501953  0.06530950 0.25562284
PMIN     0.180449445 0.4480883 0.3401565  1.00000000  0.6950989  0.159553313  0.23960598 0.06025395 0.1563026 -0.05247788 0.32265315
PMEAN    0.155489111 0.5535306 0.5604334  0.69509894  1.0000000  0.656554363  0.16348532 0.17894753 0.2036115 -0.11367780 0.30352357
PMAX    -0.001717436 0.3386288 0.4737909  0.15955331  0.6565544  1.000000000 -0.01003661 0.09917366 0.1337081 -0.14713087 0.11841517
PM2      0.473362073 0.4209321 0.1957211  0.23960598  0.1634853 -0.010036612  1.00000000 0.05729714 0.2210385  0.11480895 0.26465782
PERWH    0.127431511 0.2082640 0.2140634  0.06025395  0.1789475  0.099173660  0.05729714 1.00000000 0.6370699  0.52816946 0.06358122
NONPOOR  0.194859019 0.3315168 0.2501953  0.15630263  0.2036115  0.133708132  0.22103848 0.63706991 1.0000000  0.25565891 0.41713832
GE65     0.201578458 0.1915416 0.0653095 -0.05247788 -0.1136778 -0.147130871  0.11480895 0.52816946 0.2556589  1.00000000 0.09531892
LPOP     0.116279527 0.3767937 0.2556228  0.32265315  0.3035236  0.118415169  0.26465782 0.06358122 0.4171383  0.09531892 1.00000000
'''
# both the covariance and correlation are same
'''question2'''

'''Do you think it would be more appropriate to base a PCA on the standardised data or
the raw data? Explain your answer.'''

'''It is better to use scale data than non scaled data as PCA is not scale invariant.A principal components analysis based on the raw data may be dominated 
by a few of the original variables 
if they have much higher means and/or variances than the other variables.'''

(pca2 = prcomp(x=airpollution, scale=TRUE))
'''
Standard deviations (1, .., p=11):
 [1] 1.9589090 1.3778958 1.1793324 1.0214751 0.8790417 0.8214578 0.7377982 0.6606760 0.4573085 0.3293824 0.2896070

Rotation (n x k) = (11 x 11):
              PC1         PC2         PC3         PC4         PC5         PC6         PC7         PC8         PC9        PC10         PC11
SMIN    0.2613624  0.19024716  0.48898065  0.30389689 -0.00503646  0.16976617 -0.23357936  0.65047519 -0.10093751  0.10793791  0.188886532
SMEAN   0.4503394 -0.01348804  0.17831895  0.22217870 -0.07700225 -0.25640015 -0.16687341 -0.14094009  0.10793985 -0.24130316 -0.725666579
SMAX    0.3988570 -0.13441659 -0.05261114  0.33299140 -0.16751423 -0.32783475 -0.23117364 -0.43584227 -0.07259588  0.21225036  0.529091005
PMIN    0.3126485 -0.22716515  0.07514298 -0.35107342  0.67334658  0.02028976 -0.11701411 -0.01835620  0.21795695  0.45080432 -0.056405756
PMEAN   0.3868269 -0.34029207 -0.19234925 -0.05145100  0.26347970  0.14420155  0.14871000  0.14558294 -0.18129015 -0.68523112  0.242875167
PMAX    0.2522820 -0.34479429 -0.37450985  0.25148644 -0.30869420  0.20626628  0.44615456  0.27668187  0.19043628  0.37810587 -0.145921101
PM2     0.2404705  0.14632479  0.51477592 -0.11716178 -0.11430278  0.43974026  0.48679957 -0.43913254 -0.05078188  0.02049280  0.052870507
PERWH   0.2073243  0.45946073 -0.43826348  0.08658339  0.18383543  0.25437827 -0.07529613 -0.09090255 -0.60313853  0.18709915 -0.187409126
NONPOOR 0.2764271  0.36544285 -0.27541948 -0.29711596 -0.27193283  0.32090663 -0.34131500 -0.01058218  0.54480664 -0.13760757  0.128915709
GE65    0.1059282  0.53990856 -0.09313504  0.17056040  0.29745501 -0.43689985  0.50321729  0.10479728  0.30194137 -0.07121415  0.140363292
LPOP    0.2651881  0.04129927  0.04278853 -0.64781366 -0.37227336 -0.42692962  0.13009585  0.23828579 -0.31924187  0.09954071  0.009544292
'''
'''First two principle components are :

              PC1         PC2         PC3         PC4         PC5         PC6         PC7         PC8         PC9        PC10         PC11
SMIN    0.2613624  0.19024716  0.48898065  0.30389689 -0.00503646  0.16976617 -0.23357936  0.65047519 -0.10093751  0.10793791  0.188886532
SMEAN   0.4503394 -0.01348804  0.17831895  0.22217870 -0.07700225 -0.25640015 -0.16687341 -0.14094009  0.10793985 -0.24130316 -0.725666579
'''
colnames(airpollution)
'''
"SMIN"    "SMEAN"   "SMAX"    "PMIN"    "PMEAN"   "PMAX"    "PM2"     "PERWH"   "NONPOOR" "GE65"    "LPOP" 
'''
#* The first PC explains 20.17 of the total variation
#* The first principal component is:
#* z1	            z2	    z3	       z4	       z5	      z6	       z7	       z8	       z9	       z10	   z11
#0.2613624	0.4503394	0.398857	0.3126485	0.3868269	0.252282	0.2404705	0.2073243	0.2764271	0.1059282	0.2651881

SMIN	        SMEAN	            SMAX     	PMIN	    PMEAN	       PMAX	    PM2	       PERWH	    NONPOOR	     GE65	      LPOP
  z1	          z2	            z3	        z4	      z5	       z6	        z7	      z8	       z9	           z10	    z11
0.2613624	  0.4503394	    0.398857	  0.3126485	  0.3868269	  0.252282	0.2404705	  0.2073243	  0.2764271	  0.1059282	  0.2651881
0.19024716	-0.01348804	-0.13441659	-0.22716515	-0.34029207	-0.34479429	0.14632479	0.45946073	0.36544285	0.53990856	0.04129927


'''
Interpretation: the Pc1 
In these results, first principal component has large positive associations with SMEAN and  PMAX, so this component primarily measures mean concentrations of sulphate and mean suspended particulate
The second component has large positive association with demographic variables like GE65,Non-Poor etc , so this component primarily measures an demographic properties of the data.
Additionally, the first pc1 constitute 34.88  % fo the total variation meanwhile the pc2 constitute 17.26 % of the total variation.  

'''


summary(pca2)
'''
Importance of components:
  PC1    PC2    PC3     PC4     PC5     PC6     PC7     PC8     PC9    PC10    PC11
Standard deviation     1.9589 1.3779 1.1793 1.02148 0.87904 0.82146 0.73780 0.66068 0.45731 0.32938 0.28961
Proportion of Variance 0.3488 0.1726 0.1264 0.09486 0.07025 0.06134 0.04949 0.03968 0.01901 0.00986 0.00762
Cumulative Proportion  0.3488 0.5214 0.6479 0.74274 0.81299 0.87433 0.92382 0.96350 0.98251 0.99238 1.00000
'''
plot(pca2, type="bar", main="")
title(xlab="Component number")

#question 3
#------
# Plot the first PC against the second PC 
plot(pca2$x[,1], pca2$x[,2], xlab="First PC", ylab="Second PC")
# Add labels representing the cancer types 
text(pca2$x[,1], pca2$x[,2], labels=rownames(airpollution), cex=0.7, pos=3)
#------------------
df=data.frame(rownames(airpollution) ,airpollution$SMEAN,airpollution$PMEAN)



df %>% 
  rename(
    city = rownames.airpollution.,
    smean = airpollution.SMEAN,
    pmean=airpollution.PMEAN
  )
df=df %>% arrange(desc(airpollution.SMEAN))%>%filter(airpollution.SMEAN >=161)

ggplot(df, aes( y=airpollution.SMEAN, x=rownames.airpollution.)) + 
  geom_bar( stat="identity") + ggtitle("Sulpher pollution in each city") +
  ylab("Mean of Sulpher") + 
  xlab("City") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=0.8,size=14),axis.text.y = element_text(size=20),text=element_text(size=15))



df=data.frame(rownames(airpollution) ,airpollution$SMEAN,airpollution$PMEAN)



df %>% 
  rename(
    city = rownames.airpollution.,
    smean = airpollution.SMEAN,
    pmean=airpollution.PMEAN
  )
df=df %>% arrange(desc(airpollution.PMEAN))%>%filter(airpollution.SMEAN >=166)

ggplot(df, aes( y=airpollution.PMEAN, x=rownames.airpollution.)) + 
  geom_bar( stat="identity") + ggtitle("Particulate Pollution in each City") +
  ylab("Mean of particulate") + 
  xlab("City") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=0.8,size=14),axis.text.y = element_text(size=20),text=element_text(size=15))
